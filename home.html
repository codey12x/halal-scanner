<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Halal Scanner Pro</title>
    
    <!-- PWA & Mobile Optimization -->
    <meta name="theme-color" content="#2ecc71">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #2ecc71;       /* Halal Green */
            --danger: #e74c3c;        /* Haram Red */
            --warning: #f39c12;       /* Doubtful Orange */
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --shadow: 0 10px 30px rgba(0,0,0,0.15);
            --radius: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--dark);
        }

        /* --- DEVICE FRAME (The "Phone" look on PC) --- */
        .device-frame {
            width: 100%;
            max-width: 420px; /* Mobile width */
            background: var(--white);
            height: 100vh; /* Full height on mobile */
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* Desktop Adjustment: Make it look like a phone floating */
        @media (min-width: 480px) {
            .device-frame {
                height: 90vh;
                border-radius: 30px;
                border: 8px solid #fff;
            }
        }

        /* --- HEADER --- */
        .app-header {
            background: var(--white);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            z-index: 10;
        }

        .app-header h1 {
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .app-header i { margin-right: 8px; }

        /* --- MAIN CONTENT AREA --- */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: #fafafa;
        }

        /* --- SCANNER SECTION --- */
        .scanner-wrapper {
            background: var(--white);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            text-align: center;
            position: relative;
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            min-height: 250px;
            display: none;
        }
        
        /* Hide default ugly library borders if possible */
        #reader__scan_region { background: transparent !important; }
        #reader__dashboard { display: none !important; }

        .camera-placeholder {
            height: 250px;
            background: #f0f3f4;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
            border: 2px dashed #bdc3c7;
        }
        
        .camera-placeholder i { font-size: 3rem; margin-bottom: 10px; }
        .camera-placeholder p { font-size: 0.9rem; }

        .controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .btn:active { transform: scale(0.95); }

        .btn-primary { background: var(--dark); color: var(--white); }
        .btn-primary:hover { background: #34495e; }

        .btn-stop { background: var(--danger); color: var(--white); display: none; }

        /* --- LOADING & STATUS --- */
        .status-overlay {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #7f8c8d;
            min-height: 20px;
        }

        .loading-spinner {
            display: none; /* Flex when active */
            justify-content: center;
            padding: 15px;
            gap: 10px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(46, 204, 113, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- RESULT CARD --- */
        #result-card {
            display: none;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .product-header {
            padding: 15px;
            display: flex;
            gap: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .product-thumb {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            object-fit: cover;
            background: #eee;
            border: 1px solid #eee;
        }

        .product-details { flex: 1; }
        .product-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; line-height: 1.2; }
        .product-brand { font-size: 0.85rem; color: #95a5a6; }

        .result-status {
            padding: 20px;
            text-align: center;
            color: white;
        }

        .status-badge-large {
            font-size: 1.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .status-desc { font-size: 0.9rem; opacity: 0.95; }

        .ingredients-list {
            padding: 15px;
            background: #fff;
        }

        .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #bdc3c7; font-weight: 700; margin-bottom: 8px; display: block; }
        .text-content { font-size: 0.9rem; line-height: 1.5; color: #555; max-height: 120px; overflow-y: auto; }

        .btn-external {
            display: block;
            width: 100%;
            padding: 15px;
            background: #f8f9fa;
            color: var(--dark);
            text-decoration: none;
            text-align: center;
            font-weight: 600;
            border-top: 1px solid #eee;
            transition: background 0.2s;
        }
        .btn-external:hover { background: #e9ecef; }

        /* --- HISTORY --- */
        .history-section { margin-top: 10px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .section-title { font-size: 1.1rem; font-weight: 700; }
        .btn-clear { color: var(--danger); background: none; border: none; font-size: 0.85rem; cursor: pointer; }

        .history-list { list-style: none; }
        
        .history-item {
            background: var(--white);
            padding: 12px 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transition: transform 0.1s;
        }
        .history-item:active { transform: scale(0.98); }

        .h-info { display: flex; flex-direction: column; }
        .h-name { font-weight: 600; font-size: 0.95rem; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .h-time { font-size: 0.75rem; color: #95a5a6; margin-top: 2px; }

        .h-tag { 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 0.7rem; 
            font-weight: 700; 
            color: white; 
            text-transform: uppercase;
        }

        /* Color Themes */
        .bg-halal { background-color: var(--primary); }
        .bg-haram { background-color: var(--danger); }
        .bg-doubt { background-color: var(--warning); }
        .bg-none { background-color: #95a5a6; }

    </style>
</head>
<body>

    <div class="device-frame">
        
        <header class="app-header">
            <h1><i class="fas fa-barcode"></i> Halal Scanner</h1>
        </header>

        <main class="content-area">
            
            <!-- SCANNER AREA -->
            <section class="scanner-wrapper">
                <!-- Placeholder when camera is off -->
                <div id="camera-placeholder" class="camera-placeholder">
                    <i class="fas fa-camera"></i>
                    <p>Camera is off</p>
                </div>
                
                <!-- Actual Scanner Element -->
                <div id="reader"></div>

                <!-- Status / Loader -->
                <div id="loading-spinner" class="loading-spinner">
                    <div class="spinner"></div>
                    <span id="loading-text">Scanning...</span>
                </div>
                <div id="status-msg" class="status-overlay"></div>

                <!-- Controls -->
                <div class="controls">
                    <button id="btn-start" class="btn btn-primary">
                        <i class="fas fa-power-off"></i> Start Scan
                    </button>
                    <button id="btn-stop" class="btn btn-stop">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                </div>
            </section>

            <!-- RESULT AREA -->
            <section id="result-card">
                <div class="product-header">
                    <img id="res-img" src="" alt="Product" class="product-thumb">
                    <div class="product-details">
                        <div id="res-name" class="product-title">Product Name</div>
                        <div id="res-brand" class="product-brand">Brand</div>
                    </div>
                </div>

                <div id="res-status-box" class="result-status">
                    <div id="res-status-text" class="status-badge-large">HALAL</div>
                    <div id="res-status-sub" class="status-desc">Safe to consume</div>
                </div>

                <div class="ingredients-list">
                    <span class="label">Ingredients</span>
                    <div id="res-ingredients" class="text-content">...</div>
                </div>

                <a id="res-link" href="#" target="_blank" class="btn-external">
                    View Full Details <i class="fas fa-external-link-alt" style="margin-left:5px;"></i>
                </a>
            </section>

            <!-- HISTORY AREA -->
            <section class="history-section">
                <div class="section-header">
                    <span class="section-title">Recent Scans</span>
                    <button id="btn-clear" class="btn-clear">Clear</button>
                </div>
                <ul id="history-list" class="history-list">
                    <li style="text-align: center; color: #ccc; padding: 20px;">No history yet</li>
                </ul>
            </section>

        </main>
    </div>

    <script>
        /**
         * Halal Scanner Pro
         * Optimized for Device-Like Experience
         */
        
        // --- Config ---
        const API_URL = "https://world.openfoodfacts.org/api/v2/product/";
        const STORAGE_KEY = "halal_scanner_history_v2";
        
        // Halal Logic Keywords
        const KEYWORDS = {
            haram: ['pork', 'gelatin', 'alcohol', 'wine', 'lard', 'ham', 'bacon', 'rum', 'beer', 'carnivore', 'blood', 'rennet'],
            doubtful: ['e-number', 'e number', 'flavouring', 'natural flavour', 'enzymes', 'color', 'colour', 'additive']
        };

        // --- DOM Elements ---
        const ui = {
            reader: document.getElementById('reader'),
            placeholder: document.getElementById('camera-placeholder'),
            btnStart: document.getElementById('btn-start'),
            btnStop: document.getElementById('btn-stop'),
            spinner: document.getElementById('loading-spinner'),
            loadText: document.getElementById('loading-text'),
            statusMsg: document.getElementById('status-msg'),
            
            // Result Card
            card: document.getElementById('result-card'),
            img: document.getElementById('res-img'),
            name: document.getElementById('res-name'),
            brand: document.getElementById('res-brand'),
            statusBox: document.getElementById('res-status-box'),
            statusText: document.getElementById('res-status-text'),
            statusSub: document.getElementById('res-status-sub'),
            ingredients: document.getElementById('res-ingredients'),
            link: document.getElementById('res-link'),
            
            // History
            historyList: document.getElementById('history-list'),
            btnClear: document.getElementById('btn-clear')
        };

        let html5QrCode = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initScanner();
            loadHistory();
        });

        // --- Scanner Logic ---
        function initScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            ui.btnStart.addEventListener('click', startCamera);
            ui.btnStop.addEventListener('click', stopCamera);
            ui.btnClear.addEventListener('click', clearHistory);
        }

        async function startCamera() {
            ui.card.style.display = 'none'; // Hide previous results
            ui.placeholder.style.display = 'none';
            ui.reader.style.display = 'block';
            ui.btnStart.style.display = 'none';
            ui.btnStop.style.display = 'flex';
            ui.statusMsg.textContent = "Align barcode within frame...";
            ui.spinner.style.display = 'none';

            const config = { fps: 10, qrbox: { width: 250, height: 150 } };
            
            try {
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScanSuccess, 
                    onScanFailure
                );
            } catch (err) {
                console.error("Camera Error", err);
                ui.statusMsg.textContent = "Error: Camera access denied.";
                stopCamera();
            }
        }

        async function stopCamera() {
            if (html5QrCode && html5QrCode.isScanning) {
                await html5QrCode.stop();
                ui.reader.style.display = 'none';
                ui.placeholder.style.display = 'flex';
                ui.btnStart.style.display = 'flex';
                ui.btnStop.style.display = 'none';
                ui.statusMsg.textContent = "";
            }
        }

        function onScanFailure(error) {
            // Ignore frame scan errors, keeps console clean
        }

        async function onScanSuccess(decodedText) {
            // Stop scanning immediately
            stopCamera();
            
            // Show loading UI
            ui.spinner.style.display = 'flex';
            ui.loadText.textContent = "Fetching product info...";
            ui.statusMsg.textContent = "";

            try {
                const response = await fetch(`${API_URL}${decodedText}.json`);
                const data = await response.json();

                if (data.status === 1 && data.product) {
                    renderProduct(data.product);
                } else {
                    showError("Product not found in database.");
                }
            } catch (error) {
                console.error(error);
                showError("Network error. Please check connection.");
            }
        }

        // --- Data Processing ---
        function renderProduct(product) {
            ui.spinner.style.display = 'none';

            // Extract Data
            const name = product.product_name || "Unknown Product";
            const brand = product.brands || "Generic";
            const ingredients = product.ingredients_text || "No ingredient text available.";
            const img = product.image_front_small_url || "https://via.placeholder.com/150?text=No+Image";
            const url = product.url;

            // UI Updates
            ui.img.src = img;
            ui.name.textContent = name;
            ui.brand.textContent = brand;
            ui.ingredients.textContent = ingredients;
            ui.link.href = url;

            // Halal Analysis
            const analysis = checkHalal(ingredients);
            
            // Update Status UI
            ui.statusBox.className = `result-status bg-${analysis.className}`;
            ui.statusText.textContent = analysis.label;
            ui.statusSub.textContent = analysis.message;

            // Show Card
            ui.card.style.display = 'block';
            
            // Scroll to result on mobile
            ui.card.scrollIntoView({ behavior: 'smooth' });

            // Save to History
            saveToHistory(name, analysis.label, analysis.className);
        }

        function checkHalal(text) {
            const lower = text.toLowerCase();

            // 1. Check Haram
            const isHaram = KEYWORDS.haram.some(k => lower.includes(k));
            if (isHaram) {
                return { 
                    className: 'haram', 
                    label: 'HARAM', 
                    message: 'Contains forbidden ingredients.' 
                };
            }

            // 2. Check Doubtful
            const isDoubtful = KEYWORDS.doubtful.some(k => lower.includes(k));
            if (isDoubtful) {
                return { 
                    className: 'doubt', 
                    label: 'DOUBTFUL', 
                    message: 'Contains ambiguous additives.' 
                };
            }

            // 3. Default Halal
            return { 
                className: 'halal', 
                label: 'HALAL', 
                message: 'No obvious forbidden ingredients detected.' 
            };
        }

        function showError(msg) {
            ui.spinner.style.display = 'none';
            ui.statusMsg.textContent = msg;
            ui.statusMsg.style.color = 'var(--danger)';
        }

        // --- History Logic ---
        function saveToHistory(name, status, className) {
            const historyItem = {
                name,
                status,
                className,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            let history = getHistory();
            history.unshift(historyItem); // Add to top
            if (history.length > 5) history.pop(); // Keep last 5

            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            loadHistory();
        }

        function getHistory() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function loadHistory() {
            const history = getHistory();
            ui.historyList.innerHTML = '';

            if (history.length === 0) {
                ui.historyList.innerHTML = '<li style="text-align: center; color: #ccc; padding: 20px;">No history yet</li>';
                return;
            }

            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <div class="h-info">
                        <div class="h-name">${item.name}</div>
                        <div class="h-time">${item.time}</div>
                    </div>
                    <div class="h-tag bg-${item.className}">${item.status}</div>
                `;
                ui.historyList.appendChild(li);
            });
        }

        function clearHistory() {
            localStorage.removeItem(STORAGE_KEY);
            loadHistory();
        }

    </script>
</body>
</html>